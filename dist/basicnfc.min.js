!function(t,e){"function"==typeof define&&define.amd?define([],e):"object"==typeof exports?module.exports=e():t.TappyBasicNfcFamily=e()}(this,function(){var t=new Uint8Array([0,1]),e=function(t){var e=Array.prototype.map.call(t,function(t){return String.fromCharCode(t)}).join(""),o=e.replace(/(.)/g,function(t,e){var o=e.charCodeAt(0).toString(16).toUpperCase();return o.length<2&&(o="0"+o),"%"+o});return decodeURIComponent(o)},o=function(t){var e=encodeURIComponent(t),o=e.replace(/%([0-9A-F]{2})/g,function(t,e){return String.fromCharCode("0x"+e)}),r=new Uint8Array(o.length);return Array.prototype.forEach.call(o,function(t,e){r[e]=t.charCodeAt(0)}),r},r=function(t,e){for(var o=[],r=0;r<e.length;r++){var n=e[r];"function"!=typeof t[n]&&o.push(n)}return o},n=function(t,e){var o=r(t,e);return!(null===o||o.length>0)},i=function(t,e){return t.length==e.length&&t.every(function(t,o){return t===e[o]})},a=["getCommandFamily","getCommandCode","getPayload"],s={},p={WriteNdefUri:5,WriteNdefText:6,WriteNdefCustom:7,StreamTags:1,StreamNdef:3,Stop:0,ScanTag:2,ScanNdef:4,LockTag:8,GetLibraryVersion:255},u={TYPE1:1,GENERAL:2},d=function(e){return function(o){if("object"!=typeof o||null===o)throw new Error("Command passed to check type must be an object implementing: "+a.join(", "));if(n(o,a))return i(o.getCommandFamily(),t)&&o.getCommandCode()===e;throw new Error("Command passed to check type must also implement: "+r(o,a).join(", "))}},y=function(e){return{getCommandFamily:function(){return t},getCommandCode:function(){return e},getPayload:function(){return[]},parsePayload:function(){}}},g=function(t){var e=y(t);return e.getPayload=function(){return new Uint8Array([this.timeout,this.pollingMode])},e.parsePayload=function(t){if(t.length<2)throw new Error("Invalid payload: Basic NFC polling command payload must be at least two bytes");this.timeout=t[0],this.pollingMode=t[1]},e.getTimeout=function(){return this.timeout},e.setTimeout=function(t){this.timeout=t},e.getPollingMode=function(){return this.pollingMode},e.setPollingMode=function(t){this.pollingMode=t},e},h=function(){return function(t,e){"undefined"==typeof t?this.timeout=0:this.timeout=t,"undefined"==typeof e?this.pollingMode=u.GENERAL:this.pollingMode=e}},l=function(){};l.prototype=y(p.GetLibraryVersion),l.isTypeOf=d(p.GetLibraryVersion),s.GetLibraryVersion=l;var f=h();f.prototype=g(p.ScanNdef),f.isTypeOf=d(p.ScanNdef),s.ScanNdef=f;var c=h();c.prototype=g(p.StreamNdef),c.isTypeOf=d(p.StreamNdef),s.StreamNdef=c;var m=h();m.prototype=g(p.ScanTag),m.isTypeOf=d(p.ScanTag),s.ScanTag=m;var T=h();T.prototype=g(p.StreamTags),T.isTypeOf=d(p.StreamTags),s.StreamTags=T;var C=function(t,e){"number"==typeof t?this.timeout=t:this.timeout=0,"undefined"!=typeof e&&null!==e?this.uid=e:this.uid=new Uint8Array(0)};C.prototype=y(p.LockTag),C.isTypeOf=d(p.LockTag),C.prototype.getPayload=function(){var t=this.uid.length,e=new Uint8Array(2+t);return e[0]=this.timeout,e[1]=t,t>0&&e.set(this.uid,2),e},C.prototype.parsePayload=function(t){if(t.length<2)throw new Error("Invalid payload: Lock tag command payload must be at least two bytes");this.timeout=t[0];var e=t[1];if(e>0){if(!(e+2<=t.length))throw new Error("Invalid payload: lock tag payload too short to contain UID length claimed");this.uid=t.subarray(2,2+e)}else this.uid=new Uint8Array(0)},C.prototype.getTimeout=function(){return this.timeout},C.prototype.setTimeout=function(t){this.timeout=t},C.prototype.getTagCode=function(){return this.uid},C.prototype.setTagCode=function(t){this.uid=t},s.LockTag=C;var w=function(){};w.prototype=y(p.Stop),w.isTypeOf=d(p.Stop),s.Stop=w;var E=function(t,e,o){"undefined"==typeof t?this.timeout=0:this.timeout=t,"undefined"==typeof e?this.locks=!1:this.locks=e,"undefined"==typeof o?this.text="":this.text=o};E.prototype=y(p.WriteNdefText),E.isTypeOf=d(p.WriteNdefText),E.prototype.getPayload=function(){var t=o(this.text),e=new Uint8Array(t.length+2);return e[0]=this.timeout,e[1]=this.locks?1:0,e.set(t,2),e},E.prototype.parsePayload=function(t){if(t.length<2)throw new Error("Invalid payload: write ndef text must be at least 2 bytes long");if(this.timeout=t[0],this.locks=1===t[1],t.length>2){var o=t.slice(2);this.text=e(o)}else this.text=""},E.prototype.getTimeout=function(){return this.timeout},E.prototype.setTimeout=function(t){this.timeout=t},E.prototype.getLockFlag=function(){return this.locks},E.prototype.setLockFlag=function(t){this.locks=t},E.prototype.getText=function(){return this.text},E.prototype.setText=function(t){this.text=t},s.WriteNdefText=E;var b=function(t,e,o,r){"undefined"==typeof t?this.timeout=0:this.timeout=t,"undefined"==typeof e?this.locks=!1:this.locks=e,"undefined"==typeof o?this.uri="":this.uri=o,"undefined"==typeof r?this.uriCode=0:this.uriCode=r};b.prototype=y(p.WriteNdefUri),b.isTypeOf=d(p.WriteNdefUri),b.prototype.getPayload=function(){var t=o(this.uri),e=new Uint8Array(t.length+3);return e[0]=this.timeout,e[1]=this.locks?1:0,e[2]=this.uriCode,e.set(t,3),e},b.prototype.parsePayload=function(t){if(t.length<3)throw new Error("Invalid payload: write ndef uri must be at least 2 bytes long");if(this.timeout=t[0],this.locks=1===t[1],this.uriCode=t[2],t.length>3){var o=t.slice(3);this.uri=e(o)}else this.uri=""},b.prototype.getTimeout=function(){return this.timeout},b.prototype.setTimeout=function(t){this.timeout=t},b.prototype.getLockFlag=function(){return this.locks},b.prototype.setLockFlag=function(t){this.locks=t},b.prototype.getUri=function(){return this.uri},b.prototype.setUri=function(t){this.uri=t},b.prototype.getUriCode=function(){return this.uriCode},b.prototype.setUriCode=function(t){this.uriCode=t},s.WriteNdefUri=b;var v=function(t,e,o){"undefined"==typeof t?this.timeout=0:this.timeout=t,"undefined"==typeof e?this.locks=!1:this.locks=e,"undefined"==typeof o?this.msg=new Uint8Array(0):this.msg=o};v.prototype=y(p.WriteNdefCustom),v.isTypeOf=d(p.WriteNdefCustom),v.prototype.getPayload=function(){var t=new Uint8Array(this.msg.length+2);return t[0]=this.timeout,t[1]=this.locks?1:0,t.set(this.msg,2),t},v.prototype.parsePayload=function(t){if(t.length<2)throw new Error("Invalid payload: write ndef uri must be at least 2 bytes long");this.timeout=t[0],this.locks=1===t[1],t.length>2?this.msg=t.slice(2):this.msg=new Uint8Array(0)},v.prototype.getTimeout=function(){return this.timeout},v.prototype.setTimeout=function(t){this.timeout=t},v.prototype.getLockFlag=function(){return this.locks},v.prototype.setLockFlag=function(t){this.locks=t},v.prototype.getMessage=function(){return this.msg},v.prototype.setMessage=function(t){this.msg=t},s.WriteNdefCustom=v;var A={},k={LibraryVersion:4,TagWritten:5,TagFound:1,ScanTimeout:3,NdefFound:2,TagLocked:6,ApplicationError:127},P=function(t,e){"undefined"!=typeof t?this.tagCode=t:this.tagCode=new Uint8Array(4),"undefined"!=typeof e?this.tagType=e:this.tagType=0};P.prototype=y(k.TagWritten),P.isTypeOf=d(k.TagWritten),P.prototype.getPayload=function(){var t=new Uint8Array(this.tagCode.length+1);return t[0]=this.tagType,this.tagCode.length>0&&t.set(this.tagCode,1),t},P.prototype.parsePayload=function(t){if(t.length<1)throw new Error("Invalid Payload: tag written response must be longer than one byte");this.tagType=t[0],t.length>1?this.tagCode=t.slice(1):this.tagCode=new Uint8Array(0)},P.prototype.getTagType=function(){return this.tagType},P.prototype.setTagType=function(t){this.tagType=t},P.prototype.getTagCode=function(){return this.tagCode},P.prototype.setTagCode=function(t){this.tagCode=t},A.TagWritten=P;var N=function(t,e){"undefined"!=typeof t?this.tagCode=t:this.tagCode=new Uint8Array(4),"undefined"!=typeof e?this.tagType=e:this.tagType=0};N.prototype=y(k.TagFound),N.isTypeOf=d(k.TagFound),N.prototype.getPayload=function(){var t=new Uint8Array(this.tagCode.length+1);return t[0]=this.tagType,this.tagCode.length>0&&t.set(this.tagCode,1),t},N.prototype.parsePayload=function(t){if(t.length<1)throw new Error("Invalid Payload: tag written response must be longer than one byte");this.tagType=t[0],t.length>1?this.tagCode=t.slice(1):this.tagCode=new Uint8Array(0)},N.prototype.getTagType=function(){return this.tagType},N.prototype.setTagType=function(t){this.tagType=t},N.prototype.getTagCode=function(){return this.tagCode},N.prototype.setTagCode=function(t){this.tagCode=t},A.TagFound=N;var S=function(){};S.prototype=y(k.ScanTimeout),S.isTypeOf=d(k.ScanTimeout),A.ScanTimeout=S;var L=function(t,e,o){"undefined"!=typeof t?this.tagCode=t:this.tagCode=new Uint8Array(4),"undefined"!=typeof e?this.tagType=e:this.tagType=0,"undefined"!=typeof o?this.message=o:this.message=new Uint8Array(0)};L.prototype=y(k.NdefFound),L.isTypeOf=d(k.NdefFound),L.prototype.getPayload=function(){var t=new Uint8Array(this.tagCode.length+2+this.message.length);return t[0]=this.tagType,t[1]=this.tagCode.length,this.tagCode.length>0&&t.set(this.tagCode,2),this.message.length>0&&t.set(this.message,2+this.tagCode.length),t},L.prototype.parsePayload=function(t){if(t.length<2)throw new Error("Invalid Payload: ndef found response must be longer than one byte");this.tagType=t[0],tagCodeLength=t[1],this.tagCode=t.slice(2,tagCodeLength+2),t.length>tagCodeLength+2?this.message=t.slice(tagCodeLength+2):this.message=new Uint8Array(0)},L.prototype.getTagType=function(){return this.tagType},L.prototype.setTagType=function(t){this.tagType=t},L.prototype.getTagCode=function(){return this.tagCode},L.prototype.setTagCode=function(t){this.tagCode=t},L.prototype.getMessage=function(){return this.message},L.prototype.setMessage=function(t){this.message=t},A.NdefFound=L;var U=function(t,e){"undefined"!=typeof t&&null!==t?this.uid=t:this.uid=new Uint8Array(0),"undefined"!=typeof e&&null!==e?this.tagType=e:this.tagType=0};U.prototype=y(k.TagLocked),U.isTypeOf=d(k.TagLocked),U.prototype.getPayload=function(){var t=new Uint8Array(2+this.uid.length);return t[0]=this.tagType,t[1]=this.uid.length,this.uid.length>0&&t.set(this.uid,2),t},U.prototype.parsePayload=function(t){if(t.length<2)throw new Error("Tag locked responses must be at least 2 bytes");var e=t[1];if(e>0){if(e+2<t.length)throw new Error("Tag locked response too short to contain tag code of specified length");this.uid=t.subarray(2,2+e)}this.tagType=t[0]},U.prototype.setTagType=function(t){this.tagType=t},U.prototype.getTagType=function(){return this.tagType},U.prototype.setTagCode=function(t){this.uid=t},U.prototype.getTagCode=function(){return this.uid},A.TagLocked=U,A.LibraryVersion=function(){arguments.length<2?(this.majorVersion=0,this.minorVersion=0):(this.majorVersion=arguments[0],this.minorVersion=arguments[1])},A.LibraryVersion.prototype=y(k.LibraryVersion),A.LibraryVersion.isTypeOf=d(k.LibraryVersion),A.LibraryVersion.prototype.getPayload=function(){return new Uint8Array([this.majorVersion,this.minorVersion])},A.LibraryVersion.prototype.parsePayload=function(t){if(t.length<2)throw new Error("Firmware version responses must be at least 2 bytes");this.majorVersion=t[0],this.minorVersion=t[1]},A.LibraryVersion.prototype.getMajorVersion=function(){return this.majorVersion},A.LibraryVersion.prototype.getMinorVersion=function(){return this.minorVersion},A.LibraryVersion.prototype.setMajorVersion=function(t){this.majorVersion=t},A.LibraryVersion.prototype.setMinorVersion=function(t){this.minorVersion=t},A.ApplicationError=function(){arguments.length<3?(this.errorCode=0,this.internalErrorCode=0,this.readerStatus=0,this.message=""):(this.errorCode=arguments[0],this.internalErrorCode=arguments[1],this.readerStatus=arguments[2],arguments.length>3?this.message=arguments[3]:this.message="")},A.ApplicationError.isTypeOf=d(k.ApplicationError),A.ApplicationError.prototype=y(k.ApplicationError),A.ApplicationError.prototype.getPayload=function(){for(var t=unescape(encodeURIComponent(this.message)),e=[],o=0;o<t.length;o++)e.push(t.charCodeAt(o));var r=new Uint8Array(3+e.length);return r[0]=this.errorCode,r[1]=this.internalErrorCode,r[2]=this.readerStatus,r.set(e,3),r},A.ApplicationError.prototype.parsePayload=function(t){if(t.length<3)throw new Error("System error payload must be at least 3 bytes");this.errorCode=t[0],this.internalErrorCode=t[1],this.readerStatus=t[2],t.length>3?this.message=String.fromCharCode.apply(null,t.slice(3)):this.message=""},A.ApplicationError.prototype.getErrorCode=function(){return this.errorCode},A.ApplicationError.prototype.getInternalErrorCode=function(){return this.internalErrorCode},A.ApplicationError.prototype.getReaderStatusCode=function(){return this.readerStatus},A.ApplicationError.prototype.getErrorMessage=function(){return this.message},A.ApplicationError.prototype.setErrorCode=function(t){this.errorCode=t},A.ApplicationError.prototype.setInternalErrorCode=function(t){this.internalErrorCode=t},A.ApplicationError.prototype.setReaderStatusCode=function(t){this.readerStatus=t},A.ApplicationError.prototype.setErrorMessage=function(t){this.message=t};var V={INVALID_PARAMETER:1,RFU:2,POLLING_ERROR:3,TOO_FEW_PARAMETERS:4,NDEF_MESSAGE_TOO_LARGE:5,ERROR_CREATING_NDEF_CONTENT:6,ERROR_WRITING_NDEF_CONTENT:7,ERROR_LOCKING_TAG:8},F=function(e){if("object"!=typeof e||null===e)throw new Error("Command passed to resolver must be an object implementing: "+a.join(", "));if(!n(e,a))throw new Error("Error, command passed to resolver must also implement: "+r(e,a).join(", "));return!!i(e.getCommandFamily(),t)},R=function(){};return R.prototype.checkFamily=function(t){return F(t)},R.prototype.validate=function(t){if(F(t))return!0;throw new Error("Resolver doesn't support command's family")},R.prototype.resolveCommand=function(t){var e=null;if(this.validate(t))switch(t.getCommandCode()){case p.WriteNdefUri:e=new s.WriteNdefUri,e.parsePayload(t.getPayload());break;case p.WriteNdefText:e=new s.WriteNdefText,e.parsePayload(t.getPayload());break;case p.WriteNdefCustom:e=new s.WriteNdefCustom,e.parsePayload(t.getPayload());break;case p.StreamTags:e=new s.StreamTags,e.parsePayload(t.getPayload());break;case p.StreamNdef:e=new s.StreamNdef,e.parsePayload(t.getPayload());break;case p.Stop:e=new s.Stop,e.parsePayload(t.getPayload());break;case p.ScanTag:e=new s.ScanTag,e.parsePayload(t.getPayload());break;case p.LockTag:e=new s.LockTag,e.parsePayload(t.getPayload());break;case p.ScanNdef:e=new s.ScanNdef,e.parsePayload(t.getPayload());break;case p.GetLibraryVersion:e=new s.GetLibraryVersion,e.parsePayload(t.getPayload())}return e},R.prototype.resolveResponse=function(t){var e=null;if(this.validate(t)){var o=null;switch(t.getCommandCode()){case k.NdefFound:o=A.NdefFound;break;case k.TagWritten:o=A.TagWritten;break;case k.TagFound:o=A.TagFound;break;case k.ScanTimeout:o=A.ScanTimeout;break;case k.TagLocked:o=A.TagLocked;break;case k.LibraryVersion:o=A.LibraryVersion;break;case k.ApplicationError:o=A.ApplicationError}null!==o&&(e=new o,e.parsePayload(t.getPayload()))}return e},{Commands:s,Responses:A,ErrorCodes:V,Resolver:R,FamilyCode:t,PollingModes:u}});